Title: django后台api编写之-扩展用户模型
Date: 2018-05-26

[TOC]
## 扩展用户模型

本小节主要参考了这篇 [不错的文章](https://simpleisbetterthancomplex.com/tutorial/2016/07/22/how-to-extend-django-user-model.html) 。一般扩展django自带的用户模型，最常见的就下面两种情况，实际上这两种情况你可能都会使用到。第一种是 User 模型 和 Profile 模型的分开，然后User用来存放登录相关信息，而Profile用来存放更多的用户资料信息，一般User 和 Profile 是 onetoone 关系，这个时候我们会考虑建立一个signals文件来保证没创建一个User就会跟着创建一个Profile：

```python

from django.db.models.signals import post_save
from django.dispatch import receiver

from profiles.models import Profile

from .models import User

@receiver(post_save, sender=User)
def create_user_profile(sender, instance, created, **kwargs):
    if created:
        Profile.objects.create(user=instance)

@receiver(post_save, sender=User)
def save_user_profile(sender, instance, **kwargs):
    instance.profile.save()
```

然后你可能对django默认的auth机制，比如session cookies等不太满意，那么推荐你直接建立自己的 User 模型， 继承自 AbstractBaseUser ，我大概看了一下 AbstractBaseUser 的源码，其做的工作都是围绕着 password这个字段来的，而且只要你在settings里面定义好了:

```
AUTH_USER_MODEL = ...
```

就都是可以正常工作的。继承之后定义自己的字段这是不多用多说的，然后推荐进一步继承 `PermissionsMixin` 这个类。

```
class User(AbstractBaseUser, PermissionsMixin):
    email = models.EmailField(_('email address'), unique=True)
```

`PermissionsMixin` 这个类定义了一些群组信息还有什么的。

然后这三个字段属性有特殊含义，都是可以自己设置的：

```
    USERNAME_FIELD = 'username'
    EMAIL_FIELD = 'email'
    REQUIRED_FIELDS = ['email']
```

然后你需要写好 objects 这个 UserManager ，其继承自 `BaseUserManager` ，你可以做其他一些定制，这个是个什么东西？这个就是之前我们看到的 `Model.objects.what` 之类的这种用法。在这里你需要根据自己的情况定义好： 

- create_user
- create_superuser

这两个方法即可。就用这两个方法来控制用户的创建行为。其中 `create_superuser` 主要负责把 

- is_superuser
- is_staff 

设为True。



