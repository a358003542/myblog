Title: django后台api编写之-序列化
Date: 2018-05-26

[TOC]

## 序列化

### 理解序列化过程

django restframework的序列化类类似于django的表单类，不同的是django的表单类是用于沟通django的Model和网页form之间的桥梁；而序列化类是用于沟通django的Model类和JSON数据格式之间的桥梁。

```
注: Model -> Serializer （其data挂载的是python的dict字典值了）

serializer = SnippetSerializer(snippet)
serializer.data
# {'pk': 2, 'title': u'', 'code': u'print "hello, world"\n', 'linenos': False, 'language': u'python', 'style': u'friendly'}
```

上面这个过程通常是在视图类特殊方法下，进行一些数据库操作之后获取数据库的目标Model的记录，然后送入序列化类，然后目标类的 `.data` 属性就是字典值了，送入Response哪里就可以作为HTTP响应的结果值了。



然后还有下面这种用法，将某个字典data送入序列化类的data属性中，

```
serializer = SnippetSerializer(data=data)
```

调用序列化类的save方法来进一步完成相应的数据库操作。

```
serializer.save()
```

这个save方法具体行为依赖于你进一步定义序列化类里面的 `create` 和 `update` 方法。如下所示：

```
    def create(self, validated_data):
        return Comment.objects.create(**validated_data)

    def update(self, instance, validated_data):
        instance.email = validated_data.get('email', instance.email)
        instance.content = validated_data.get('content', instance.content)
        instance.created = validated_data.get('created', instance.created)
        instance.save()
        return instance
```

某些情况下你可能想直接定义save方法。



### ModelSerializer

类似于django的表单类，可以利用 `ModelSerializer` 类来更快地创建序列化类。

```python
from rest_framework import serializers

class SnippetSerializer(serializers.ModelSerializer):
    class Meta:
        model = Snippet
        fields = ('id', 'title', 'code', 'linenos', 'language', 'style')
```

为了证明这种简便写法对于上面的任务（包括create和update方法都会自动实现的）是完全应付得过来的。上面在shell里的代码再撸一遍。

```
>>> from snippets.models import Snippet
>>> snippet = Snippet(code='print "hello, world2"\n')
>>> from snippets.serializers import SnippetSerializer
>>> snippet.save()
>>> serializer = SnippetSerializer(snippet)
>>> serializer.data
{'language': 'python', 'linenos': False, 'id': 3, 'title': '', 'code': 'print "hello, world2"\n', 'style': 'friendly'}
```



### is_valid 方法

```
serializer.is_valid(raise_exception=True)
```

你可以定义 `validate` 方法来进行目标对象的验证行为，或者定义 `validate_<fieldname>` 来定义字段级别的验证行为。

```python
    def validate(self, data):
        """
        Check that the start is before the stop.
        """
        if data['start'] > data['finish']:
            raise serializers.ValidationError("finish must occur after start")
        return data
```



### 在序列化类里面引用request.user

参考了 [这个问题](https://stackoverflow.com/questions/30203652/how-to-get-request-user-in-django-rest-framework-serializer) ，在序列化类里面需要通过 `self.context['request']` 来获取 request 对象，进而获取 user对象。

```
user =  self.context['request'].user
```

