Title: django后台api编写之-部署
Date: 2018-05-26

[TOC]
# 部署

这里所谓的部署就是用apache或nginx这样的web服务器来对接django项目，说的再具体一点就把django作为一个wsgi程序服务起来。

本文关于apache的部署讲解较为成熟。

## apache
上例子吧：

```
<IfModule !wsgi_module>
    LoadModule wsgi_module modules/mod_wsgi.so
</IfModule>

WSGIPythonHome "/home/wanze/venv"
WSGIPythonPath "/home/wanze/venv/webapp"

<VirtualHost *:80>
    ServerName api.cdwanze.work
	
    WSGIScriptAlias / /home/wanze/venv/webapp/webapp/wsgi.py
	
    <Directory /home/wanze/venv/webapp >
        <IfVersion >= 2.4>
            Require all granted
        </IfVersion>
        <IfVersion < 2.4>
            Order deny,allow
            Allow from all
        </IfVersion>
    </Directory>

	Alias "/static" "/home/wanze/venv/webapp/static"
    
    <Directory  /home/wanze/venv/webapp/static >
        <IfVersion >= 2.4>
            Require all granted
        </IfVersion>
        <IfVersion < 2.4>
            Order deny,allow
            Allow from all
        </IfVersion>
    </Directory>
    
</VirtualHost>
```


- 首先是检测wsgi模块加载了没有，没有把它加载上。

- WSGIPythonHome 这个设置你的python的虚拟环境的所在目录，比如上面的例子 venv/bin下面就是python可执行脚本。

- WSGIPythonPath 这个设置你的Django项目目录所在

- WSGIScriptAlias 这个设置你的WSGI文件所在

- Alias 和下面Directory 设置是服务你的项目的静态文件的。


### 关于静态文件
关于静态文件再补充下，上面服务的静态文件是在项目目录下的static文件夹下，这里所谓的静态文件主要是djano和djangorestframwork等框架带的静态文件，其通过  `python manage.py collectstatic` 命令来生成这些内容。

你需要在settings那里设置 `STATIC_ROOT` 值。
```
STATIC_ROOT= os.path.join(BASE_DIR, 'static')
```



### 多django站点部署问题

多个django站点都通过 `mod_wsgi` 来部署是不能继续像前面那样写： 

```
WSGIScriptAlias / /path/to/mysite.com/mysite/wsgi.py
WSGIPythonHome /path/to/venv
WSGIPythonPath /path/to/mysite.com
```

而必须每个通过deamon模式来（参考了 [这个网页](https://stackoverflow.com/questions/14923083/multiple-sites-in-django) ）：

```
<VirtualHost *:80>
    ServerName api.cdwanze.work
    WSGIDaemonProcess cdwanze_api  processes=1 python-path=/home/wanze/venv/myapi python-home=/home/wanze/venv/ threads=10	
    WSGIProcessGroup cdwanze_api
    WSGIScriptAlias / /home/wanze/venv/myapi/myapi/wsgi.py process-group=cdwanze_api
    ...
```

其中 `WSGIProcessGroup` 目前来看名字是随意的，但必须写。然后在定义daemon进程的时候 `python-path` 是定义到你的django project那里， `python-home` 是定义到你的python虚拟环境那里。



### 文件权限问题

除了上面设置好 Directory 之外，你可能还会遇到其他某些文件的读写权限问题，在查看日志的时候发现提示说那个文件没有权限读写了。这个时候首先要明确httpd的执行User和Group是谁，然后在看目标文件夹或文件的具体权限。

Django项目的wsgi文件是需要有执行权限的。还有Django项目操纵数据库，比如sqlite3这种文件数据库，你可能也会遇到读写权限问题。

还有值得一提的是如果某个母文件夹没有可执行权限，那么里面的所有文件都是不可见的。

## nginx

nginx要对接wsgi接口需要uwsgi这个模块将wsgi接口服务起来。

    pip install uwsgi

更多细节请参看uwsgi的 [官方文档](http://uwsgi-docs.readthedocs.io/en/latest/tutorials/Django_and_nginx.html) 。

ngnix的配置如下：

    upstream django {
        server 127.0.0.1:8001; 
    }
    
    server {
        location / {
            uwsgi_pass  django;
            include     /path/to/your/mysite/uwsgi_params; 
        }
    }



### nginx serve 静态文件

    server {
        listen      80;
        ......
     
        client_max_body_size 75M;
     
        location /media  {
            alias /path/to/media;
        }
     
        location /static {
            alias /path/to/static;
        }
        
        ......
    }




更多nginx配置细节请参看我写的关于nginx配置的专门的文章。



## 对外部署必看

django项目如果对外部署的话，因为python是一个动态脚本语言，所以会有很多安全性的问题需要检查，否则你的项目对外会很不安全。本文主要参看官方文档的 [这里](https://docs.djangoproject.com/en/2.0/howto/deployment/checklist/) 。

第一当然首先是确保 `DEBUG=False` ，对外开着 `DEBUG=True` 那简单是开玩笑了。

然后是运行：

```
python manage.py check --deploy
```

 ### settings.py 里密钥外置

settings.py 文件里面不要有任何密钥信息，包括 `SECRET_KEY` 你的数据库连接信息或者其他密钥等等，所有这些信息都应该作为环境变量引入或者从某个配置文件中读取出来。

### ALLOWED_HOSTS

要某是限定好域名，要某是你的nginx服务器那边对入口请求已经做好了限定，凡是不认识的域名HOST请求都抛出444错误：

```
server {
    listen 80 default_server;
    return 444;
}
```

