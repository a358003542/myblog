Title: django后台api编写之-邮箱认证
Date: 2018-05-26

[TOC]

## 邮箱认证

参考了 [这篇文章](https://medium.com/@frfahim/django-registration-with-confirmation-email-bb5da011e4ef) 。

过程分为两步，发送验证邮箱，和接受确认邮箱链接：

```
    re_path(r'^users/verify_email/?$', VerifyEmailView.as_view(), name='users_verify_email'),

    re_path(r'^users/confirm_email/(?P<uidb64>[0-9A-Za-z_\-]+)/(?P<token>[0-9A-Za-z]{1,13}-[0-9A-Za-z]{1,20})/?$',
            ConfirmEmailView.as_view(), name='users_confirm_email'),
```

发送邮件的过程主要是填写一些必要信息，发送邮件即可：

```python
class VerifyEmailView(APIView):
    permission_classes = (IsAuthenticated,)

    def post(self, request):
        profile = request.user
        user = profile.user
        current_site = get_current_site(request)

        mail_subject = '请确认你的邮箱.'
        message = render_to_string('verify_email.html', {
            'user': user,
            'domain': current_site.domain,
            'uid': urlsafe_base64_encode(force_bytes(user.pk)).decode('utf8'),
            'token': PasswordResetTokenGenerator().make_token(user),
        })

        to_email = user.email
        email = EmailMessage(
            mail_subject, message, to=[to_email]
        )
        email.send()

        return Response({'info': "邮件已发送，请查收您的邮箱。"})
```

确认邮件的过程是：

```python
class ConfirmEmailView(APIView):
    permission_classes = (AllowAny,)

    def get(self, request, uidb64, token):
        uid = urlsafe_base64_decode(uidb64)

        user = None

        try:
            profile = Profile.objects.get(pk = uid)
            user = profile.user
        except Profile.DoesNotExist:
            pass

        if (user is not None) and  PasswordResetTokenGenerator().check_token(user, token):
            user.is_email_verified = True
            user.save()
            return Response({'info': "您的邮箱已经被确认。"})
        else:
            return Response({'info': '无效的激活链接。'})

```

这其中最大的技术点就是传递的token的加密解密过程。

具体这里利用了django自带的密码重置的token检验系统：

```
'token': PasswordResetTokenGenerator().make_token(user),
```

```
PasswordResetTokenGenerator().check_token(user, token)
```

这个有点类似于JWT 的token过程，然后额外加上的uid方便判断登录用户。

